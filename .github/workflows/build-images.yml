name: Build and Push Docker Images

on:
  push:
    branches: [main]
    paths:
      - 'images/**'
      - 'manifest.json'
  pull_request:
    branches: [main]
    paths:
      - 'images/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository }}

jobs:
  # Layer 1: Base
  build-base:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base image
        uses: docker/build-push-action@v5
        with:
          context: images/base
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_PREFIX }}/base:latest
          cache-from: type=gha,scope=base
          cache-to: type=gha,mode=max,scope=base

  # Layer 2: Dev Environments
  build-dev-images:
    runs-on: ubuntu-latest
    needs: build-base
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - name: dev-node
            path: images/dev/node
          - name: dev-python
            path: images/dev/python
          - name: dev-go
            path: images/dev/go
          - name: dev-rust
            path: images/dev/rust
          - name: dev-fullstack
            path: images/dev/fullstack
          - name: dev-desktop
            path: images/dev/desktop
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.path }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_PREFIX }}/${{ matrix.name }}:latest
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}
          build-args: |
            BASE_REGISTRY=${{ env.IMAGE_PREFIX }}

  # Layer 3: Agent Images
  build-agent-images:
    runs-on: ubuntu-latest
    needs: build-dev-images
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - name: claude-code
            path: images/agents/claude-code
          - name: gemini-cli
            path: images/agents/gemini-cli
          - name: copilot
            path: images/agents/copilot
          - name: aider
            path: images/agents/aider
          - name: cursor
            path: images/agents/cursor
          - name: opencode
            path: images/agents/opencode
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.path }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_PREFIX }}/${{ matrix.name }}:latest
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}
          build-args: |
            BASE_REGISTRY=${{ env.IMAGE_PREFIX }}

  # Run tests after all images are built
  test:
    runs-on: ubuntu-latest
    needs: build-agent-images
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull all images
        run: |
          for img in base dev-node dev-python dev-go dev-rust dev-fullstack dev-desktop claude-code gemini-cli copilot aider cursor opencode; do
            docker pull ${{ env.IMAGE_PREFIX }}/${img}:latest
            docker tag ${{ env.IMAGE_PREFIX }}/${img}:latest proxifai/${img}:latest
          done

      - name: Run test suite
        run: bash tests/test.sh
        env:
          REGISTRY: proxifai
